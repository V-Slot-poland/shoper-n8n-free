{
  "name": "Shoper - Weekly Sales Report + AI (No Credentials - GitHub Version)",
  "nodes": [
    {
      "parameters": {
        "content": "## Shoper - Weekly Report + AI\n\nâ° Automatically every Monday at 08:00\nðŸ“Š Sends weekly report to Slack\nðŸ¤– AI analyzes current week (Mon-Sun)\n\n**Features:**\n- Fetches orders from current week (Monday-Sunday)\n- Week-over-week comparison\n- AI creates intelligent summary\n- Daily breakdown\n- Trend insights\n- Sends report to Slack\n\n**Manual run:**\n- Click 'Test workflow'\n- Or send message via Chat Trigger",
        "height": 480,
        "width": 450
      },
      "id": "sticky-note-1",
      "name": "Info",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-112, 368]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "weeksInterval": 1,
              "triggerAtDay": 1,
              "triggerAtHour": 8,
              "triggerAtMinute": 0
            }
          ]
        }
      },
      "id": "schedule-trigger-1",
      "name": "Every Monday at 08:00",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [688, 300]
    },
    {
      "parameters": {},
      "id": "manual-trigger-1",
      "name": "When clicking 'Test workflow'",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [688, 450]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "chat-trigger-1",
      "name": "When chat message received",
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [688, 608],
      "webhookId": "shoper-weekly-report"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=You are an e-commerce expert analyzing weekly sales data from Shoper.\n\nYou respond ONLY IN POLISH, professionally and analytically.\n\nYou have access to functions:\n- getTygodnioweZamowienia() - fetches orders from last 7 days (current week) and previous 7 days (previous week) from Shoper\n\nToday's date: {{ $now.format('yyyy-MM-dd') }}\n\nTask:\n1. Call getTygodnioweZamowienia() function\n2. Analyze results thoroughly\n3. Create comprehensive weekly summary containing:\n   - ðŸ“Š Overall week assessment\n   - ðŸ“ˆ Key metrics (orders count, total revenue, average order value)\n   - ðŸ“‰ Week-over-week comparison (current vs previous week)\n   - ðŸ† Top insights (best days, trends)\n   - ðŸ’¡ Actionable recommendations\n   - ðŸŽ¯ Areas for improvement\n\nUse emojis for better readability.\nBe specific, data-driven and actionable.\nHighlight significant changes (growth/decline).\nProvide strategic recommendations based on trends.",
        "options": {
          "systemMessage": "You are an AI assistant for e-commerce analytics. You analyze weekly sales trends and give strategic recommendations. You respond ONLY in Polish. You focus on actionable insights and data-driven decisions."
        }
      },
      "id": "ai-agent-1",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [1012, 450]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {
          "maxTokens": 1500,
          "temperature": 0.7
        }
      },
      "id": "openai-model-1",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [1012, 626],
      "credentials": {
        "openAiApi": {
          "id": "YOUR_OPENAI_CREDENTIAL_ID",
          "name": "OpenAI account"
        }
      }
    },
    {
      "parameters": {
        "name": "getTygodnioweZamowienia",
        "description": "Fetches orders from last 7 days (current week) and previous 7 days (previous week) from Shoper API. First gets access_token via /auth endpoint, then fetches orders for both periods. No parameters required. Returns: date range, current week stats, previous week stats, comparison, daily breakdown.",
        "jsCode": "// Calculate date ranges - week starts on Monday, ends on Sunday\nconst today = new Date();\nconst dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.\n\n// Calculate current week (Monday to Sunday)\n// If today is Sunday (0), we need to go back 6 days to get Monday\n// If today is Monday (1), we need to go back 0 days\n// If today is Tuesday (2), we need to go back 1 day, etc.\nconst daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;\n\nconst currentWeekStart = new Date(today);\ncurrentWeekStart.setDate(currentWeekStart.getDate() - daysFromMonday);\ncurrentWeekStart.setHours(0, 0, 0, 0);\n\nconst currentWeekEnd = new Date(currentWeekStart);\ncurrentWeekEnd.setDate(currentWeekEnd.getDate() + 6); // +6 days = Sunday\ncurrentWeekEnd.setHours(23, 59, 59, 999);\n\n// Calculate previous week (Monday to Sunday)\nconst previousWeekStart = new Date(currentWeekStart);\npreviousWeekStart.setDate(previousWeekStart.getDate() - 7);\n\nconst previousWeekEnd = new Date(currentWeekStart);\npreviousWeekEnd.setDate(previousWeekEnd.getDate() - 1); // Day before current week Monday = previous Sunday\npreviousWeekEnd.setHours(23, 59, 59, 999);\n\n// Format dates as YYYY-MM-DD\nconst formatDate = (date) => date.toISOString().split('T')[0];\n\nconst currentWeekStartStr = formatDate(currentWeekStart);\nconst currentWeekEndStr = formatDate(currentWeekEnd);\nconst previousWeekStartStr = formatDate(previousWeekStart);\nconst previousWeekEndStr = formatDate(previousWeekEnd);\n\n// Shoper API configuration - REPLACE WITH YOUR VALUES\nconst shopUrl = 'YOUR_SHOP.shoper.pl';\nconst username = 'YOUR_SHOPER_USERNAME';\nconst password = 'YOUR_SHOPER_PASSWORD';\n\n// Step 1: Get access_token from /auth endpoint\nconst authString = Buffer.from(username + ':' + password).toString('base64');\n\nconst authResponse = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://' + shopUrl + '/webapi/rest/auth',\n  headers: {\n    'Authorization': 'Basic ' + authString,\n    'Content-Type': 'application/json'\n  }\n});\n\nif (!authResponse.access_token) {\n  return 'Error: Could not get access token from Shoper API';\n}\n\nconst accessToken = authResponse.access_token;\n\n// Step 2: Fetch recent orders (we'll fetch more to cover both weeks)\n// Shoper filters don't work reliably, so we fetch last 200 orders and filter client-side\nconst options = {\n  method: 'GET',\n  url: 'https://' + shopUrl + '/webapi/rest/orders?limit=200&order=order_id+DESC',\n  headers: {\n    'Authorization': 'Bearer ' + accessToken,\n    'Content-Type': 'application/json'\n  }\n};\n\ntry {\n  const response = await this.helpers.httpRequest(options);\n  const allOrders = response.list || [];\n  \n  // Filter orders by date ranges\n  const currentWeekOrders = [];\n  const previousWeekOrders = [];\n  const dailyStats = {}; // For daily breakdown\n  \n  for (const order of allOrders) {\n    const orderDate = (order.date || '').substring(0, 10);\n    const orderValue = parseFloat(order.sum) || 0;\n    \n    // Check if order is in current week\n    if (orderDate >= currentWeekStartStr && orderDate <= currentWeekEndStr) {\n      currentWeekOrders.push(order);\n      \n      // Track daily stats\n      if (!dailyStats[orderDate]) {\n        dailyStats[orderDate] = { count: 0, value: 0 };\n      }\n      dailyStats[orderDate].count++;\n      dailyStats[orderDate].value += orderValue;\n    }\n    \n    // Check if order is in previous week\n    if (orderDate >= previousWeekStartStr && orderDate <= previousWeekEndStr) {\n      previousWeekOrders.push(order);\n    }\n  }\n  \n  // Calculate current week stats\n  let currentWeekValue = 0;\n  let currency = 'PLN';\n  \n  for (const order of currentWeekOrders) {\n    currentWeekValue += parseFloat(order.sum) || 0;\n    if (order.currency_id && !currency) {\n      currency = order.currency_id;\n    }\n  }\n  \n  // Calculate previous week stats\n  let previousWeekValue = 0;\n  for (const order of previousWeekOrders) {\n    previousWeekValue += parseFloat(order.sum) || 0;\n  }\n  \n  // Calculate metrics\n  const currentWeekCount = currentWeekOrders.length;\n  const previousWeekCount = previousWeekOrders.length;\n  const currentWeekAvg = currentWeekCount > 0 ? currentWeekValue / currentWeekCount : 0;\n  const previousWeekAvg = previousWeekCount > 0 ? previousWeekValue / previousWeekCount : 0;\n  \n  // Calculate changes (week-over-week)\n  const countChange = previousWeekCount > 0 \n    ? ((currentWeekCount - previousWeekCount) / previousWeekCount * 100).toFixed(1)\n    : (currentWeekCount > 0 ? '+100' : '0');\n  \n  const valueChange = previousWeekValue > 0\n    ? ((currentWeekValue - previousWeekValue) / previousWeekValue * 100).toFixed(1)\n    : (currentWeekValue > 0 ? '+100' : '0');\n  \n  const avgChange = previousWeekAvg > 0\n    ? ((currentWeekAvg - previousWeekAvg) / previousWeekAvg * 100).toFixed(1)\n    : (currentWeekAvg > 0 ? '+100' : '0');\n  \n  // Build daily breakdown\n  const dailyBreakdown = [];\n  const sortedDates = Object.keys(dailyStats).sort();\n  \n  for (const date of sortedDates) {\n    const stats = dailyStats[date];\n    const dayName = new Date(date + 'T12:00:00').toLocaleDateString('pl-PL', { weekday: 'short' });\n    dailyBreakdown.push(\n      `${date} (${dayName}): ${stats.count} zam., ${stats.value.toFixed(2)} ${currency}`\n    );\n  }\n  \n  // Build result string\n  let result = 'WEEKLY SALES REPORT (SHOPER)\\n';\n  result += '=================================\\n\\n';\n  \n  result += 'ðŸ“… PERIOD\\n';\n  result += `Current week: ${currentWeekStartStr} - ${currentWeekEndStr}\\n`;\n  result += `Previous week: ${previousWeekStartStr} - ${previousWeekEndStr}\\n\\n`;\n  \n  result += 'ðŸ“Š CURRENT WEEK (LAST 7 DAYS)\\n';\n  result += `Orders: ${currentWeekCount}\\n`;\n  result += `Total revenue: ${currentWeekValue.toFixed(2)} ${currency}\\n`;\n  result += `Average order value: ${currentWeekAvg.toFixed(2)} ${currency}\\n\\n`;\n  \n  result += 'ðŸ“‰ PREVIOUS WEEK\\n';\n  result += `Orders: ${previousWeekCount}\\n`;\n  result += `Total revenue: ${previousWeekValue.toFixed(2)} ${currency}\\n`;\n  result += `Average order value: ${previousWeekAvg.toFixed(2)} ${currency}\\n\\n`;\n  \n  result += 'ðŸ“ˆ WEEK-OVER-WEEK CHANGE\\n';\n  result += `Orders: ${countChange}%\\n`;\n  result += `Revenue: ${valueChange}%\\n`;\n  result += `Average order value: ${avgChange}%\\n\\n`;\n  \n  if (dailyBreakdown.length > 0) {\n    result += 'ðŸ“† DAILY BREAKDOWN (CURRENT WEEK)\\n';\n    result += dailyBreakdown.join('\\n');\n  } else {\n    result += 'ðŸ“† No orders in current week.';\n  }\n  \n  return result;\n  \n} catch (error) {\n  return 'Error fetching Shoper orders: ' + error.message;\n}"
      },
      "id": "tool-code-1",
      "name": "getTygodnioweZamowienia Tool",
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.1,
      "position": [1412, 674]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "YOUR_SLACK_CHANNEL_ID",
          "mode": "list"
        },
        "text": "=ðŸ“Š *WEEKLY SHOPER REPORT*\nðŸ“… Report date: {{ $now.format('yyyy-MM-dd') }}\n\n{{ $json.output }}\n\n_Report generated automatically every Monday at 08:00_",
        "otherOptions": {}
      },
      "id": "slack-1",
      "name": "Send to Slack",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1232, 450],
      "credentials": {
        "slackApi": {
          "id": "YOUR_SLACK_CREDENTIAL_ID",
          "name": "Slack account"
        }
      }
    }
  ],
  "connections": {
    "Every Monday at 08:00": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking 'Test workflow'": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send to Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "getTygodnioweZamowienia Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
